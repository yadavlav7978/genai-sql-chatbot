<div class="chat-container">
  <!-- Sidebar -->
  <aside class="sidebar" [class.hidden]="!showSidebar">
    <div class="sidebar-header">
      <div class="sidebar-avatar">
        <img src="../../../assets/Screenshot 2025-12-02 211321.png" alt="Assistant">
      </div>
      <h2 class="sidebar-title">SQL ChatBot</h2>
      <button class="btn-icon" (click)="toggleSidebar()" title="Hide sidebar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12" />
        </svg>
      </button>
    </div>

    <button class="btn btn-primary new-chat-btn" (click)="newConversation()" *ngIf="uploadedFiles.length > 0">
      ðŸ”„ New Chat
    </button>

    <!-- Active Agent Status Section -->
    <div class="agent-status-section" *ngIf="lastSelectedAgent">
      <div class="agent-status-header">
        <span class="agent-status-title">Agent selected by orchestrator</span>
      </div>
      <div class="agent-status-badge">
        <div class="agent-pulse-indicator"></div>
        <span class="agent-name">{{ getFormattedAgentName() }}</span>
      </div>
    </div>
    <!-- Session Info Section - Hidden from UI, but session management remains in backend -->
    <div class="session-info-section" *ngIf="false">
      <div class="session-info-header">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
        <span class="session-info-title">Active Session</span>
      </div>
      <div class="session-details">
        <span class="session-id" [title]="sessionId">{{ sessionId }}</span>
      </div>
    </div>

    <div class="conversations-list">
      <div class="conversation-item" *ngFor="let conv of conversations">
        <span class="conversation-title">{{ conv.title }}</span>
        <span class="conversation-preview">{{ conv.lastMessage }}</span>
      </div>
    </div>


    <div class="sidebar-footer" *ngIf="uploadedFiles.length > 0">
      <button class="btn btn-primary upload-files-btn" (click)="openUploadModal()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg>
        Upload Files
      </button>
    </div>
  </aside>

  <!-- Upload Modal -->
  <div class="modal-backdrop" *ngIf="showUploadModal" (click)="closeUploadModal()"></div>
  <div class="upload-modal" *ngIf="showUploadModal">
    <div class="modal-header">
      <div class="modal-title-group">
        <h2>Upload Files</h2>
        <p>Please Upload your Excel Files </p>
      </div>
      <button class="btn-icon close-modal-btn" (click)="closeUploadModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18" />
          <line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- Left Section: Drag & Drop -->
      <div class="upload-section left-section" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)">
        <div class="drop-zone">
          <div class="cloud-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path
                d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.244 17.819 10.022C17.3821 6.13454 14.0981 3.125 10 3.125C5.8 3.125 2.36 6.35 2.04 10.56C0.979998 11.08 0.25 12.18 0.25 13.44C0.25 15.41 1.84 17 3.81 17H5" />
              <path d="M12 11L12 21" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              <path d="M8 15L12 11L16 15" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </div>
          <p class="drop-text">Drag and drop files here</p>
          <p class="separator">-OR-</p>
          <label class="btn btn-primary browse-btn">
            Browse Files
            <input type="file" multiple accept=".xlsx,.xls,.csv" (change)="onFileSelected($event)"
              style="display: none;">
          </label>
        </div>
      </div>

      <!-- Right Section: File List -->
      <div class="upload-section right-section">
        <div class="files-header">
          <h3>Uploaded Files</h3>
          <button class="btn-text-danger" *ngIf="uploadedFiles.length > 0" (click)="deleteAllFiles()">
            Delete All Files
          </button>
        </div>

        <div class="file-list-preview" *ngIf="uploadedFiles.length > 0; else noFiles">
          <div class="file-preview-item" *ngFor="let file of uploadedFiles">
            <div class="file-icon"
              [ngClass]="{'xls': file.filename.endsWith('.xls') || file.filename.endsWith('.xlsx'), 'csv': file.filename.endsWith('.csv')}">
              <!-- Simple File Icon based on type -->
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                *ngIf="file.filename.endsWith('.csv')">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <text x="8" y="18" font-size="6" fill="currentColor" font-weight="bold">CSV</text>
              </svg>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                *ngIf="!file.filename.endsWith('.csv')">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="8" y1="13" x2="16" y2="13" stroke="currentColor" stroke-width="2"></line>
                <line x1="8" y1="17" x2="16" y2="17" stroke="currentColor" stroke-width="2"></line>
                <line x1="10" y1="9" x2="9" y2="9" stroke="currentColor" stroke-width="2"></line>
              </svg>
            </div>
            <div class="file-details">
              <span class="file-name" title="{{file.filename}}">{{file.filename}}</span>
              <div class="progress-bar-container">
                <div class="progress-bar filled"></div>
              </div>
            </div>
            <span class="upload-status">Completed</span>
            <button class="btn-icon delete-btn-small" (click)="deleteFile(file.file_id)">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
        <ng-template #noFiles>
          <div class="empty-state">
            <p>No files uploaded yet.</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Main Chat Area -->
  <main class="chat-main">
    <!-- Header -->
    <header class="chat-header enhanced-header">
      <div class="header-left">
        <button class="btn-icon sidebar-toggle-btn" (click)="toggleSidebar()" *ngIf="!showSidebar" title="Show sidebar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12" />
            <line x1="3" y1="6" x2="21" y2="6" />
            <line x1="3" y1="18" x2="21" y2="18" />
          </svg>
        </button>
      </div>
      <div class="header-centered">
        <div class="sidebar-header-row">

          <h1 class="sidebar-title-big">AskYourDatabase</h1>

          <div class="sidebar-avatar small-avatar">
            <img src="../../../assets/Database Storage free icons designed by phatplus.jpg" alt="Assistant">

          </div>
        </div>


        <p>Connect your database and start chatting with your data.</p>
      </div>

      <div class="header-actions" *ngIf="uploadedFiles && uploadedFiles.length > 0">
        <button class="btn btn-secondary schema-toggle-btn" (click)="toggleSchema()" [class.active]="showSchema">
          {{ showSchema ? 'Hide' : 'Show' }} Schema
        </button>
      </div>
    </header>



    <!-- Schema Viewer Panel -->
    <div class="schema-panel" *ngIf="showSchema && uploadedFiles && uploadedFiles.length > 0"
      [class.expanded]="showSchema">
      <div class="schema-panel-header">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
            <polyline points="10 9 9 9 8 9" />
          </svg>
          Database Schemas ({{ uploadedFiles.length }} file{{uploadedFiles.length > 1 ? 's' : ''}})
        </h3>
        <button class="btn-icon" (click)="toggleSchema()" title="Close schema">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>

      <div class="schema-content-grid" *ngIf="uploadedFiles && uploadedFiles.length > 0">

        <div class="schema-card" *ngFor="let file of uploadedFiles">

          <!-- File Header -->
          <div class="schema-card-header">
            <h4>{{ file.filename }}</h4>
            <span class="table-name-badge">{{ file.table_name }}</span>
          </div>

          <!-- Table Schema -->
          <div *ngIf="getFileSchema(file.file_id)">
            <div class="table-schema" *ngFor="let table of getFileSchema(file.file_id)?.tables">

              <div class="table-stats">
                <span class="stat-badge">{{ table.row_count }} rows</span>
                <span class="stat-badge">{{ table.column_count }} columns</span>
              </div>

              <hr />

              <!-- Columns -->
              <div class="column-item" *ngFor="let column of table.columns">
                <strong>{{ column.name }}</strong> ({{ column.type }})
                <div class="column-badges">
                  <span class="badge badge-pk" *ngIf="column.is_potential_primary_key">PK</span>
                  <span class="badge badge-nullable" *ngIf="column.nullable">Nullable</span>
                </div>

                <div class="column-details">
                  <div>Unique: {{ column.unique_count }}</div>
                  <div *ngIf="column.null_count > 0">
                    Nulls: {{ column.null_count }} ({{ column.null_percentage }}%)
                  </div>
                  <div *ngIf="column.sample_values?.length">
                    Samples: {{ column.sample_values.join(', ') }}
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- Active Chat Interface -->
    <div class="chat-interface">

      <!-- Welcome / Empty State -->
      <div class="welcome-state-container" *ngIf="!uploadedFiles || uploadedFiles.length === 0">
        <div class="empty-state-content">
          <div class="empty-state-icon">
            <div class="welcome-avatar-ring">
              <img src="../../../assets/Screenshot 2025-12-02 211321.png" alt="SQL Chatbot" class="welcome-robot">
            </div>
          </div>
          <h2>Welcome to SQL ChatBot</h2>
          <p>Upload an Excel or CSV file to ask questions and explore your data using natural language.</p>

          <button class="btn btn-primary start-upload-btn" (click)="openUploadModal()">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            Upload File
          </button>
        </div>
      </div>

      <!-- Messages Container -->
      <div class="messages-container" #chatContainer *ngIf="uploadedFiles && uploadedFiles.length > 0">
        <div class="message-wrapper fade-in" *ngFor="let message of messages"
          [ngClass]="{ 'user-wrapper': message.role === 'user' }">

          <!-- User Message -->
          <div class="message message-user" *ngIf="message.role === 'user'">
            <div class="message-content">
              <div class="message-text">{{ message.content }}</div>
              <div class="message-time">{{ formatTimestamp(message.timestamp) }}</div>
            </div>
          </div>

          <!-- Assistant Message -->
          <div class="message message-assistant" *ngIf="message.role === 'assistant'">
            <div class="message-avatar">
              <img src="../../../assets/Google ADK.jpg" alt=" Assistant">
            </div>
            <div class="message-content">
              <!-- Legacy content -->
              <div class="message-text" *ngIf="message.content" [innerHTML]="formatMessage(message.content)"></div>

              <!-- Combined Explanation + Query Result Section -->
              <div class="query-result-section" *ngIf="message.explanation || message.queryResult">
                <!-- Explanation text (no heading, above results) -->
                <div class="section-content explanation-content" *ngIf="message.explanation"
                  [innerHTML]="formatMessage(message.explanation)">
                </div>

                <!-- Query Results (with header + table/content) -->
                <ng-container *ngIf="message.queryResult">
                  <ng-container *ngIf="parseQueryResult(message.queryResult) as parsedResult; else rawDisplay">
                    <div class="section-header">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        <line x1="3" y1="9" x2="21" y2="9" />
                        <line x1="9" y1="21" x2="9" y2="9" />
                      </svg>
                      <span>Query Results</span>
                    </div>
                    <div class="section-content">
                      <div class="results-table-wrapper">
                        <div class="table-container">
                          <table>
                            <thead>
                              <tr>
                                <th *ngFor="let column of parsedResult.columns">{{ column }}</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr *ngFor="let row of parsedResult.data">
                                <td *ngFor="let column of parsedResult.columns">{{ row[column] }}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        <div class="row-count-display" *ngIf="parsedResult.row_count>0">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M9 11H3v2h6v-2zm0-4H3v2h6V7zm0 8H3v2h6v-2z" />
                            <path
                              d="M21 3H11c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 16H12V6h8v13z" />
                          </svg>
                          <span><strong>Total Rows:</strong> {{ parsedResult.row_count }}</span>
                        </div>
                      </div>
                    </div>
                  </ng-container>
                  <ng-template #rawDisplay>
                    <div class="section-header">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                        <line x1="3" y1="9" x2="21" y2="9" />
                        <line x1="9" y1="21" x2="9" y2="9" />
                      </svg>
                      <span>Query Results</span>
                    </div>
                    <div class="section-content" [innerHTML]="formatMessage(message.queryResult)"></div>
                  </ng-template>
                </ng-container>
                <!-- Suggestions Section -->
                <div class="section-content suggestions-content" *ngIf="message.suggestions"
                  [innerHTML]="formatMessage(message.suggestions)">
                </div>
              </div>



              <!-- Error Message -->
              <div class="error-message" *ngIf="message.error">
                {{ message.error }}
              </div>

              <div class="message-time">{{ formatTimestamp(message.timestamp) }}</div>
            </div>
          </div>
        </div>

        <!-- Loading Indicator -->
        <div class="message message-assistant" *ngIf="isLoading">
          <div class="message-avatar">
            <img src="../../../assets/Google ADK.jpg" alt=" Assistant">
          </div>
          <div class="message-content">
            <div class="loading-indicator">
              <div class="loading"></div>
              <span>Querying Database...</span>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Input Area (Always Visible) -->
    <div class="input-area">
      <div class="input-container">
        <input type="text" [(ngModel)]="userMessage" (keydown.enter)="sendMessage()"
          placeholder="Ask a question about your data..." class="message-input"
          [disabled]="isLoading || !uploadedFiles || uploadedFiles.length === 0" />
        <div class="input-actions">
          <label class="btn-icon file-upload-btn"
            [title]="uploadedFiles && uploadedFiles.length > 0 ? 'Upload new Excel file' : 'Upload Excel file'">
            <input type="file" #fileInput multiple accept=".xlsx,.xls,.csv" (change)="onFileSelected($event)"
              style="display: none;" />
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
          </label>
          <button class="btn btn-primary send-btn" (click)="sendMessage()"
            [disabled]="!userMessage.trim() || isLoading || !uploadedFiles || uploadedFiles.length === 0"
            [title]="!uploadedFiles || uploadedFiles.length === 0 ? 'Please upload files first' : 'Send message'">
            <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13" />
              <polygon points="22 2 15 22 11 13 2 9 22 2" />
            </svg>
          </button>
        </div>
      </div>
    </div>

  </main>
</div>